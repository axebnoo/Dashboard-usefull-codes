import React, { useState, useEffect } from "react";
import { SheetComponent } from "@antv/s2-react";
import { setLang } from '@antv/s2';
import { merge } from 'lodash';
setLang('en_US');

const BORDER_COLOR = '#fff';
const BACK_COLOR = '#fff';
const HEADER_BACK_COLOR = '#1c5691';
const CELL_ACTIVE_BACK_COLOR = '#1c5691';

const GridSheet = (props) => {

    const [s2options, setS2options] = useState({
        interaction: {
            hoverHighlight: true,
            brushSelection: {
                data: true,
                row: true,
                col: true,
            },
            enableCopy: true,
        },
        tooltip: {
            showTooltip: true,
            operation: {
                trend: true
            },
            row: {
                showTooltip: false,
            },
        },
        style: {
            colCfg: {
                hideMeasureColumn: true
            },
            layoutWidthType: "colAdaptive" /*compact*/
        },
        conditions: {
            background: [
                {
                    field: 'lastvalue',
                    mapping(value) {
                        if (value == null) {
                            return {
                                fill: '#fff'
                            }
                        }
                    },
                },
            ],
        }
    });

    const [optionProcess, setOptionProcess] = useState({
        interaction: {
            hoverHighlight: true,
            brushSelection: {
                data: true,
                row: true,
                col: true,
            },
            enableCopy: true,
        },
        tooltip: {
            showTooltip: true,
            operation: {
                trend: true
            },
            row: {
                showTooltip: false,
            },
        },
        style: {
            colCfg: {
                hideMeasureColumn: true
            },
            layoutWidthType: "colAdaptive" /*compact*/
        },
        conditions: {
            interval: [
                {
                    field: 'lastvalue',
                    mapping(value) {
                        return {
                            fill: '#80BFFF',
                            isCompare: true,
                            maxValue: 100,
                            minValue: 0,
                        };
                    },
                },
            ]
        }
    });

    const [optionThreshold, setOptionThreshold] = useState();

    const onThresholdColor = (value) => {
        let color = "#fff";
        props.optionThreshold?.map((r, index) => {
            if (value) {
                if (value >= r.from && value <= r.to) {
                    color = r.color;
                }
            }

        })
        return color;
    }

    useEffect(() => {
        setOptionThreshold(
            {
                interaction: {
                    hoverHighlight: true,
                    brushSelection: {
                        data: true,
                        row: true,
                        col: true,
                    },
                    enableCopy: true
                },
                tooltip: {
                    showTooltip: true,
                    operation: {
                        hiddenColumns: true,
                        trend: true
                    },
                    row: {
                        showTooltip: false,
                    },
                },
                style: {
                    colCfg: {
                        hideMeasureColumn: true
                    },
                    layoutWidthType: "colAdaptive" /*compact*/
                },
                conditions: {
                    background: [
                        {
                            field: 'lastvalue',
                            mapping(value) {
                                return { fill: props.isRate ? onThresholdColor(value) : '#fff' }
                            },
                        }
                    ],
                }
            }
        );
    }, [props.optionThreshold]);

    const customTheme = {
        background: {
            color: "#fff",
        },
        cornerCell: {
            cell: {
                horizontalBorderColor: BORDER_COLOR,
                verticalBorderColor: BORDER_COLOR,
                verticalBorderWidth: 0.5,
                horizontalBorderWidth: 0.5,
                backgroundColor: HEADER_BACK_COLOR,
            },
            text: {
                fill: '#fff',
            },
            bolderText: {
                fill: '#fff',
                opacity: 1,
                fontWeight: 500,
                fontFamily: "\"Noto Sans KR\", \"Helvetica Neue\", Arial, sans-serif",
                fontSize: 11
            },
        },
        splitLine: {
            horizontalBorderColor: BORDER_COLOR,
            horizontalBorderColorOpacity: 1,
            horizontalBorderWidth: 1,
            verticalBorderColor: '#e6e6e6',
            verticalBorderColorOpacity: 1,
            verticalBorderWidth: 0.5,
            showRightShadow: true,
            shadowWidth: 10,
            shadowColors: {
                left: 'rgba(0,0,0,0.1)',
                right: 'rgba(0,0,0,0)',
            },
        },
        rowCell: {
            cell: {
                horizontalBorderColor: '#e6e6e6',
                verticalBorderColor: '#e6e6e6',
                verticalBorderWidth: 0.5,
                horizontalBorderWidth: 0.5,
                backgroundColor: '#fff',
                interactionState: {
                    hover: {
                        backgroundColor: '#fff',
                        backgroundOpacity: 1,
                    },
                    selected: {
                        backgroundColor: '#f4f4f4'
                    }
                }
            },
            bolderText: {
                fill: '#212529',
                opacity: 1,
                fontFamily: "\"Noto Sans KR\", \"Helvetica Neue\", Arial, sans-serif",
                fontWeight: 500,
                fontSize: 11
            },
            text: {
                fill: '#212529',
                fontFamily: "\"Noto Sans KR\", \"Helvetica Neue\", Arial, sans-serif",
                fontSize: 10
            },
        },

        colCell: {
            cell: {
                horizontalBorderColor: '#fff',
                verticalBorderColor: '#fff',
                verticalBorderWidth: 0.5,
                horizontalBorderWidth: 0.5,
                padding: {
                    top: 12,
                    right: 8,
                    bottom: 12,
                    left: 8,
                },
                backgroundColor: HEADER_BACK_COLOR,
                interactionState: {
                    hover: {
                        backgroundColor: CELL_ACTIVE_BACK_COLOR,
                        backgroundOpacity: 1,
                    },
                    selected: {
                        backgroundColor: 'rgb(63, 69, 97)',
                    },
                },
            },
            text: {
                fill: '#fff',
                fontFamily: "\"Noto Sans KR\", \"Helvetica Neue\", Arial, sans-serif",
                fontSize: 10
            },
            bolderText: {
                fill: '#fff',
                fontWeight: 500,
                fontSize: 11,
                fontFamily: "\"Noto Sans KR\", \"Helvetica Neue\", Arial, sans-serif",
                opacity: 1,
            },
            measureText: {
                fill: '#fff',
                fontWeight: 500,
                fontSize: 11,
                fontFamily: "\"Noto Sans KR\", \"Helvetica Neue\", Arial, sans-serif"
            }
        },
        scrollBar: {
            lineCap: 'butt',
            size: 10
        },
        dataCell: {
            icon: {
                size: 14,
                margin: {
                    left: 10,
                },
            },
            cell: {
                interactionState: {
                    hover: {
                        backgroundColor: null,
                        backgroundOpacity: 1,
                    },
                    hoverFocus: {
                        backgroundColor: null,
                        backgroundOpacity: 1,
                        borderColor: '#fff',
                    },
                    selected: {
                        backgroundColor: null
                    },
                    unselected: {
                        backgroundOpacity: 1,
                        opacity: 1,
                    },
                    prepareSelect: {
                        // borderColor: CELL_ACTIVE_BACK_COLOR,
                    },
                },
                horizontalBorderColor: '#e6e6e6',
                verticalBorderColor: '#e6e6e6',
                verticalBorderWidth: 0.5,
                horizontalBorderWidth: 0.5,
                padding: {
                    top: 0,
                    right: 8,
                    bottom: 2,
                    left: 0,
                },
                backgroundColorOpacity: 1,
                backgroundColor: BACK_COLOR,
                crossBackgroundColor: BACK_COLOR,
            },
            text: {
                fill: '#212529',
                fontFamily: "\"Noto Sans KR\", \"Helvetica Neue\", Arial, sans-serif",
                fontSize: 11
            }
        },
    };

    const getFormatter =
        (enablePrefix = false) =>
            (value) => {
                const prefix = enablePrefix && value > 0 ? '+' : '';
                const suffix = value !== 0 ? (props.isRate ? '%' : '') : '';
                if (value) {
                    return `${prefix}${value}${suffix}`;
                } else {
                    return ' ';
                }
            };

    const dataCfg = {
        fields: {
            rows: ["hostgroupname", "hostname"],
            columns: ["tag", "tagvalue", "name"],
            values: ["lastvalue"],
            valueInCols: true
        },
        meta: [
            {
                field: "hostgroupname",
                name: "Group"
            },
            {
                field: "hostname",
                name: "Host"
            },
            {
                field: "tag",
                name: ""
            },
            {
                field: "tagvalue",
                name: ""
            },
            {
                field: "lastvalue",
                name: "Value",
                formatter: getFormatter()
            },
            {
                field: "name",
                name: ""
            }
        ],
        data: props.dataGrid
    };

    const getOptions = () => {
        return optionThreshold;
    };
    
    return (
        <SheetComponent
            sheetType={'pivot'}
            adaptive={{
                width: true,
                height: true
            }}
            dataCfg={dataCfg}
            options={getOptions()}
            themeCfg={{
                theme: merge({}, customTheme),
            }}
        />
    );
};

export default GridSheet;
